<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deep Learning: Why object oriented? | Home</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Deep Learning: Why object oriented?" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="http://localhost:4000/2023/12/10/oo-vs-functional.html" />
<meta property="og:url" content="http://localhost:4000/2023/12/10/oo-vs-functional.html" />
<meta property="og:site_name" content="Home" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-12-10T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deep Learning: Why object oriented?" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-10T00:00:00+01:00","datePublished":"2023-12-10T00:00:00+01:00","description":"Introduction","headline":"Deep Learning: Why object oriented?","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/12/10/oo-vs-functional.html"},"url":"http://localhost:4000/2023/12/10/oo-vs-functional.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Home" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Home</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deep Learning: Why object oriented?</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-12-10T00:00:00+01:00" itemprop="datePublished">Dec 10, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>

<p>Why are deep learning frameworks implemented with object-oriented programming? It is a question that programmers probably don`t ask themselves but I have a maths and R background where people typically use functional programming. I asked myself this question when I looked at the way layers and models are implemented in Keras.</p>

<p>For example, this is a very naive object-oriented implementation of a dense layer:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_naive_dense</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">self</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new.env</span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">emptyenv</span><span class="p">())</span><span class="w">
  </span><span class="nf">attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="s2">"class"</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"NaiveDense"</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">activation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">activation</span><span class="w">

  </span><span class="n">w_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="p">)</span><span class="w">
  </span><span class="n">w_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">random_array</span><span class="p">(</span><span class="n">w_shape</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e-1</span><span class="p">)</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">w_initial_value</span><span class="p">)</span><span class="w">

  </span><span class="n">b_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="w">
  </span><span class="n">b_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">b_shape</span><span class="p">)</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">b_initial_value</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">call</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">self</span><span class="o">$</span><span class="n">activation</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">self</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Here, we are creating a function <code class="language-plaintext highlighter-rouge">layer_naive_dense</code> that creates an object of type <code class="language-plaintext highlighter-rouge">NaiveDense</code> when initiated. The object will have the following properties:</p>

<ul>
  <li>W: The weights of the layer.</li>
  <li>b: The biases of the layer.</li>
  <li>weights: A list that contains both weights and biases.</li>
  <li>activation: The activation function to be used in the layer.</li>
</ul>

<p>Furthermore, it has a method <code class="language-plaintext highlighter-rouge">call</code> which will do the matrix multiplications and return the transformed input.</p>

<p>But why donÂ´t we just implement it as a simple function? Because thats what a dense layer in a neural network actually is, when you look at it from a mathematical perspective. The following would be a simple <code class="language-plaintext highlighter-rouge">layer_naive_dense</code> function:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_naive_dense</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">activation</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Wow, so much more clear! The main difference is that we now pass the weights to the function as well. That means the weights need to be initialized outside of the dense layer. Would that make the code easier or more difficult?</p>

<p>Deep Learning models are just simple functions - chained. Everything needs to be differentiable to make backpropagation work. The essential machine-learning steps are simple functions appied one after the other. Would it help us, if we implement deep-learning in functional programming style? Would it make the code more explicit and easy to understand? Lets try it out and write an end-to-end deep learning implementation to train a model that classifies MNIST (handwritten number classification) ! We will try to keep everything low-level to maximize our understanding of the code.</p>

<h2 id="the-object-oriented-implementation">The object oriented implementation</h2>

<p>Our object oriented implementation will be the following. It is largely taken from <em>Deep Learning with R (second edition)</em> from FranÃ§ois Chollet.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">keras</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tensorflow</span><span class="p">)</span><span class="w">

</span><span class="n">random_array</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
  </span><span class="n">array</span><span class="p">(</span><span class="n">runif</span><span class="p">(</span><span class="nf">prod</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">),</span><span class="n">dim</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">layer_naive_dense</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">self</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new.env</span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">emptyenv</span><span class="p">())</span><span class="w">
  </span><span class="nf">attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="s2">"class"</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"NaiveDense"</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">activation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">activation</span><span class="w">

  </span><span class="n">w_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="p">)</span><span class="w">
  </span><span class="n">w_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">random_array</span><span class="p">(</span><span class="n">w_shape</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1e-1</span><span class="p">)</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">w_initial_value</span><span class="p">)</span><span class="w">

  </span><span class="n">b_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span><span class="w">
  </span><span class="n">b_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">b_shape</span><span class="p">)</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">b_initial_value</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">call</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">self</span><span class="o">$</span><span class="n">activation</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">b</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">self</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">naive_model_sequential</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">self</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new.env</span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">emptyenv</span><span class="p">())</span><span class="w">
  </span><span class="nf">attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="s2">"class"</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"NaiveSequential"</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">layers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">layers</span><span class="w">

  </span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span><span class="w"> </span><span class="n">layer</span><span class="o">$</span><span class="n">weights</span><span class="p">)</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">do.call</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">call</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">inputs</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">layer</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">layers</span><span class="p">)</span><span class="w">
      </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">layer</span><span class="o">$</span><span class="nf">call</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="n">x</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">self</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">new_batch_generator</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">self</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new.env</span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">emptyenv</span><span class="p">())</span><span class="w">
  </span><span class="nf">attr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="s2">"class"</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"BatchGenerator"</span><span class="w">

  </span><span class="n">stopifnot</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">images</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">images</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">labels</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">batch_size</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">batch_size</span><span class="w">
  </span><span class="n">self</span><span class="o">$</span><span class="n">num_batches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ceiling</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_size</span><span class="p">)</span><span class="w">

  </span><span class="n">self</span><span class="o">$</span><span class="n">get_next_batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">index</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">))</span><span class="w">
      </span><span class="nf">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">

    </span><span class="n">end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">batch_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">))</span><span class="w">
      </span><span class="n">end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="w">

    </span><span class="n">self</span><span class="o">$</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="n">indices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start</span><span class="o">:</span><span class="n">end</span><span class="w">
    </span><span class="nf">list</span><span class="p">(</span><span class="n">images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">images</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="p">],</span><span class="w">
         </span><span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="o">$</span><span class="n">labels</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">self</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">one_training_step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">images_batch</span><span class="p">,</span><span class="w"> </span><span class="n">labels_batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">with</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">GradientTape</span><span class="p">()</span><span class="w"> </span><span class="o">%as%</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="nf">call</span><span class="p">(</span><span class="n">images_batch</span><span class="p">)</span><span class="w">
    </span><span class="n">per_sample_losses</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
      </span><span class="n">loss_sparse_categorical_crossentropy</span><span class="p">(</span><span class="n">labels_batch</span><span class="p">,</span><span class="w"> </span><span class="n">predictions</span><span class="p">)</span><span class="w">
    </span><span class="n">average_loss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">per_sample_losses</span><span class="p">)</span><span class="w">
  </span><span class="p">})</span><span class="w">
  </span><span class="n">gradients</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tape</span><span class="o">$</span><span class="n">gradient</span><span class="p">(</span><span class="n">average_loss</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="n">weights</span><span class="p">)</span><span class="w">
  </span><span class="n">update_weights</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="n">weights</span><span class="p">)</span><span class="w">
  </span><span class="n">average_loss</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">update_weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span><span class="w">
    </span><span class="n">weights</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="o">$</span><span class="n">assign_sub</span><span class="p">(</span><span class="n">gradients</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1e-3</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">fit_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">epochs</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="p">,</span><span class="w"> </span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="n">test_labels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">epoch_counter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_len</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="s2">"Epoch "</span><span class="p">,</span><span class="w"> </span><span class="n">epoch_counter</span><span class="p">,</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">)</span><span class="w">
    </span><span class="n">batch_generator</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new_batch_generator</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">)</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">batch_counter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_len</span><span class="p">(</span><span class="n">batch_generator</span><span class="o">$</span><span class="n">num_batches</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">batch_generator</span><span class="o">$</span><span class="n">get_next_batch</span><span class="p">()</span><span class="w">
      </span><span class="n">loss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">one_training_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="o">$</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">batch</span><span class="o">$</span><span class="n">labels</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="nf">call</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span><span class="w">
    </span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">max.col</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="n">matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">test_labels</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"accuracy: %.2f\n"</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">matches</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>After we load the functions above, we can train a model to classify MNIST with the following code:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mnist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dataset_mnist</span><span class="p">()</span><span class="w">
</span><span class="n">train_images</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array_reshape</span><span class="p">(</span><span class="n">mnist</span><span class="o">$</span><span class="n">train</span><span class="o">$</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">60000</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">255</span><span class="w">
</span><span class="n">test_images</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array_reshape</span><span class="p">(</span><span class="n">mnist</span><span class="o">$</span><span class="n">test</span><span class="o">$</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">255</span><span class="w">
</span><span class="n">test_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mnist</span><span class="o">$</span><span class="n">test</span><span class="o">$</span><span class="n">y</span><span class="w">
</span><span class="n">train_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mnist</span><span class="o">$</span><span class="n">train</span><span class="o">$</span><span class="n">y</span><span class="w">

</span><span class="n">model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">naive_model_sequential</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="w">
  </span><span class="n">layer_naive_dense</span><span class="p">(</span><span class="n">input_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">nn</span><span class="o">$</span><span class="n">relu</span><span class="p">),</span><span class="w">
  </span><span class="n">layer_naive_dense</span><span class="p">(</span><span class="n">input_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">nn</span><span class="o">$</span><span class="n">softmax</span><span class="p">)</span><span class="w">
</span><span class="p">))</span><span class="w">

</span><span class="n">fit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="n">train_labels</span><span class="p">,</span><span class="w"> </span><span class="n">epochs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="p">,</span><span class="w"> </span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="n">test_labels</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>After ~30 Epochs it reaches an accuracy of around 90% which sounds great but is actually really bad compared if we replace our simple weights update with a standard optimizer like rmsprop. That one would reach ~98% accuracy after 5 epochs.
Anyway, this post is not about training the best model. It is about understanding the differences between object oriented and functional programming implementations.</p>

<p>We can generate predictions with:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="o">$</span><span class="nf">call</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span><span class="w">
</span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">max.col</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="n">matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">test_labels</span><span class="w">
</span><span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"accuracy: %.2f\n"</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">matches</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Easy to use, right?</p>

<p>How would that look like if we implement it via functional programming?</p>

<h2 id="the-functional-implementation">The functional implementation</h2>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">keras</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tensorflow</span><span class="p">)</span><span class="w">

</span><span class="n">layer_naive_dense</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">activation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">activation</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">matmul</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">initialize_weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">layer_config</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">){</span><span class="w">
  </span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w">

  </span><span class="n">random_array</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="w">
    </span><span class="n">array</span><span class="p">(</span><span class="n">runif</span><span class="p">(</span><span class="nf">prod</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">),</span><span class="n">dim</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">

  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">layer_config</span><span class="p">)){</span><span class="w">
    </span><span class="n">w_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">layer_config</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="o">$</span><span class="n">input_size</span><span class="p">,</span><span class="w"> </span><span class="n">layer_config</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">output_size</span><span class="p">)</span><span class="w">
    </span><span class="n">w_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">random_array</span><span class="p">(</span><span class="n">w_shape</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">)</span><span class="w">

    </span><span class="n">b_shape</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">layer_config</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">output_size</span><span class="p">)</span><span class="w">
    </span><span class="n">b_initial_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">b_shape</span><span class="p">)</span><span class="w">

    </span><span class="n">weights</span><span class="p">[[</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"W_"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">w_initial_value</span><span class="p">)</span><span class="w">
    </span><span class="n">weights</span><span class="p">[[</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"b_"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Variable</span><span class="p">(</span><span class="n">b_initial_value</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">update_weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">stopifnot</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span><span class="w">
    </span><span class="n">weights</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="o">$</span><span class="n">assign_sub</span><span class="p">(</span><span class="n">gradients</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1e-3</span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">){</span><span class="w">

  </span><span class="n">activations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">nn</span><span class="o">$</span><span class="n">relu</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">nn</span><span class="o">$</span><span class="n">softmax</span><span class="p">)</span><span class="w">

  </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">activations</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">){</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"Make sure the length of activations matches length of weights!"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">inputs</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">)){</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">layer_naive_dense</span><span class="p">(</span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weights</span><span class="p">[[</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"W_"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]],</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">weights</span><span class="p">[[</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"b_"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)]],</span><span class="w"> </span><span class="n">activation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activations</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">one_epoch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">num_batches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ceiling</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">batch_size</span><span class="p">)</span><span class="w">
  </span><span class="n">start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">

  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">num_batches</span><span class="p">){</span><span class="w">
    </span><span class="n">end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="n">indices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">start</span><span class="o">:</span><span class="n">end</span><span class="w">
    </span><span class="n">images_batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="n">images</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="n">labels_batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">labels</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="w">

    </span><span class="n">with</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">GradientTape</span><span class="p">()</span><span class="w"> </span><span class="o">%as%</span><span class="w"> </span><span class="n">tape</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">images_batch</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">
      </span><span class="n">per_sample_loss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">loss_sparse_categorical_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labels_batch</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">predictions</span><span class="p">)</span><span class="w">
      </span><span class="n">average_loss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">per_sample_loss</span><span class="p">)</span><span class="w">
    </span><span class="p">})</span><span class="w">
    </span><span class="n">gradients</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tape</span><span class="o">$</span><span class="n">gradient</span><span class="p">(</span><span class="n">average_loss</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">
    </span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">update_weights</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">

    </span><span class="n">start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">learning_weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">epochs</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">epoch_counter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_len</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="s2">"Epoch "</span><span class="p">,</span><span class="w"> </span><span class="n">epoch_counter</span><span class="p">,</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">)</span><span class="w">
    </span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">one_epoch</span><span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">

    </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span><span class="w">
    </span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">max.col</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="n">matches</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predicted_labels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">as.array</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span><span class="w">
    </span><span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"accuracy: %.2f\n"</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">matches</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">mnist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dataset_mnist</span><span class="p">()</span><span class="w">

</span><span class="n">train_images</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array_reshape</span><span class="p">(</span><span class="n">mnist</span><span class="o">$</span><span class="n">train</span><span class="o">$</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">60000</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">255</span><span class="w">
</span><span class="n">test_images</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">array_reshape</span><span class="p">(</span><span class="n">mnist</span><span class="o">$</span><span class="n">test</span><span class="o">$</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span><span class="w"> </span><span class="m">28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">28</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">255</span><span class="w">
</span><span class="n">test_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mnist</span><span class="o">$</span><span class="n">test</span><span class="o">$</span><span class="n">y</span><span class="w">
</span><span class="n">train_labels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mnist</span><span class="o">$</span><span class="n">train</span><span class="o">$</span><span class="n">y</span><span class="w">

</span><span class="n">weights_initial</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">initialize_weights</span><span class="p">(</span><span class="w">
  </span><span class="n">layer_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w">
    </span><span class="nf">list</span><span class="p">(</span><span class="n">input_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="o">*</span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span><span class="p">),</span><span class="w">
    </span><span class="nf">list</span><span class="p">(</span><span class="n">input_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">512</span><span class="p">,</span><span class="w"> </span><span class="n">output_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">learning_weights</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="n">train_labels</span><span class="p">,</span><span class="w"> </span><span class="n">epochs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weights_initial</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>


  </div><a class="u-url" href="/2023/12/10/oo-vs-functional.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Home</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Home</li><li><a class="u-email" href="mailto:alex.schmitz1608@gmail.com">alex.schmitz1608@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/schmitzi89"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">schmitzi89</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Its never too late to learn something new.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
